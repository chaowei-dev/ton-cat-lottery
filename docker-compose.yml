# ğŸ³ TON Cat Lottery Docker Compose
# çµ±ä¸€ç®¡ç†æ™ºèƒ½åˆç´„å’Œå¾Œç«¯æœå‹™
services:
  # ================================
  # æ™ºèƒ½åˆç´„æœå‹™
  # ================================
  contracts:
    build:
      context: .
      dockerfile: docker/Dockerfile.contracts
    container_name: ton-cat-lottery-contracts
    networks:
      - ton-lottery-network
    volumes:
      # å°‡æ§‹å»ºç”¢ç‰©æŒä¹…åŒ–åˆ°å®¿ä¸»æ©Ÿ
      - ./contracts/build:/app/build
      - ./contracts/deployments:/app/deployments
    environment:
      - NODE_ENV=development
      - TON_NETWORK=testnet
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'test', '-f', './build/CatLottery_CatLottery.ts']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ================================
  # å¾Œç«¯æœå‹™
  # ================================
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: ton-cat-lottery-backend
    ports:
      - '8080:8080'
    networks:
      - ton-lottery-network
    environment:
      # æœå‹™é…ç½®
      - ENVIRONMENT=docker
      - LOG_LEVEL=info
      - PORT=8080

      # TON ç¶²è·¯é…ç½®
      - TON_API_ENDPOINT=https://testnet.toncenter.com/api/v2/
      - TON_NETWORK=testnet

      # åˆç´„åœ°å€ (éœ€è¦å¯¦éš›éƒ¨ç½²å¾Œå¡«å…¥)
      - LOTTERY_CONTRACT_ADDRESS=${LOTTERY_CONTRACT_ADDRESS:-EQBGhqLAZseEqRXz4ByFPTGV7SVMlI4hrbs-Sps_Xzx01x8G}
      - NFT_CONTRACT_ADDRESS=${NFT_CONTRACT_ADDRESS:-EQDGhqLAZseEqRXz4ByFPTGV7SVMlI4hrbs-Sps_Xzx01x8H}

      # éŒ¢åŒ…é…ç½®
      - WALLET_PRIVATE_KEY=${WALLET_PRIVATE_KEY:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}

      # æŠ½çåƒæ•¸
      - DRAW_INTERVAL=5m
      - MAX_PARTICIPANTS=5
      - MIN_PARTICIPANTS=2
      - ENTRY_FEE_TON=0.1
      - AUTO_DRAW=false

      # é‡è©¦é…ç½®
      - RETRY_COUNT=3
      - RETRY_DELAY=5s
    depends_on:
      contracts:
        condition: service_healthy
    restart: unless-stopped
    # å¾Œç«¯æ˜¯å®ˆè­·é€²ç¨‹ï¼Œä¸æä¾› HTTP APIï¼Œæš«æ™‚è¨»é‡‹å¥åº·æª¢æŸ¥
    # healthcheck:
    #   test: ['CMD', 'curl', '-f', 'http://localhost:8080/health']
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 15s

  # ================================
  # ç›£æ§æœå‹™ (å¯é¸)
  # ================================
  monitor:
    image: prom/prometheus:latest
    container_name: ton-cat-lottery-monitor
    ports:
      - '9090:9090'
    networks:
      - ton-lottery-network
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    profiles:
      - monitoring

# ================================
# ç¶²è·¯é…ç½®
# ================================
networks:
  ton-lottery-network:
    driver: bridge
    name: ton-lottery-network

# ================================
# æ•¸æ“šå·é…ç½®
# ================================
volumes:
  contracts-build:
    name: ton-lottery-contracts-build
  backend-logs:
    name: ton-lottery-backend-logs
