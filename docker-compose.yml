# 🐳 TON Cat Lottery Docker Compose
# 統一管理智能合約和後端服務
services:
  # ================================
  # 智能合約服務
  # ================================
  contracts:
    build:
      context: .
      dockerfile: docker/Dockerfile.contracts
    container_name: ton-cat-lottery-contracts
    networks:
      - ton-lottery-network
    volumes:
      # 將構建產物持久化到宿主機
      - ./contracts/build:/app/build
      - ./contracts/deployments:/app/deployments
    environment:
      - NODE_ENV=development
      - TON_NETWORK=testnet
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'test', '-f', './build/CatLottery_CatLottery.ts']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ================================
  # 後端服務
  # ================================
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: ton-cat-lottery-backend
    ports:
      - '8080:8080'
    networks:
      - ton-lottery-network
    environment:
      # 服務配置
      - ENVIRONMENT=docker
      - LOG_LEVEL=info
      - PORT=8080

      # TON 網路配置
      - TON_API_ENDPOINT=https://testnet.toncenter.com/api/v2/
      - TON_NETWORK=testnet

      # 合約地址 (需要實際部署後填入)
      - LOTTERY_CONTRACT_ADDRESS=${LOTTERY_CONTRACT_ADDRESS:-EQBGhqLAZseEqRXz4ByFPTGV7SVMlI4hrbs-Sps_Xzx01x8G}
      - NFT_CONTRACT_ADDRESS=${NFT_CONTRACT_ADDRESS:-EQDGhqLAZseEqRXz4ByFPTGV7SVMlI4hrbs-Sps_Xzx01x8H}

      # 錢包配置
      - WALLET_PRIVATE_KEY=${WALLET_PRIVATE_KEY:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}

      # 抽獎參數
      - DRAW_INTERVAL=5m
      - MAX_PARTICIPANTS=5
      - MIN_PARTICIPANTS=2
      - ENTRY_FEE_TON=0.1
      - AUTO_DRAW=false

      # 重試配置
      - RETRY_COUNT=3
      - RETRY_DELAY=5s
    depends_on:
      contracts:
        condition: service_healthy
    restart: unless-stopped
    # 後端是守護進程，不提供 HTTP API，暫時註釋健康檢查
    # healthcheck:
    #   test: ['CMD', 'curl', '-f', 'http://localhost:8080/health']
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 15s

  # ================================
  # 監控服務 (可選)
  # ================================
  monitor:
    image: prom/prometheus:latest
    container_name: ton-cat-lottery-monitor
    ports:
      - '9090:9090'
    networks:
      - ton-lottery-network
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    profiles:
      - monitoring

# ================================
# 網路配置
# ================================
networks:
  ton-lottery-network:
    driver: bridge
    name: ton-lottery-network

# ================================
# 數據卷配置
# ================================
volumes:
  contracts-build:
    name: ton-lottery-contracts-build
  backend-logs:
    name: ton-lottery-backend-logs
