# ğŸ³ TON Cat Lottery Docker Compose
# çµ±ä¸€ç®¡ç†å¾Œç«¯æœå‹™å’Œå‰ç«¯æ‡‰ç”¨
services:
  # ================================
  # å¾Œç«¯æœå‹™
  # ================================
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: ton-cat-lottery-backend
    ports:
      - '8080:8080'
    networks:
      - ton-lottery-network
    env_file:
      - .env # å¾æ ¹ç›®éŒ„çš„ .env æª”æ¡ˆè®€å–ç’°å¢ƒè®Šæ•¸
    environment:
      # æœå‹™é…ç½® - å¾ .env è®€å–ï¼Œå…è¨±è¦†è“‹
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PORT=${PORT:-8080}

      # TON ç¶²è·¯é…ç½® - å¾ .env è®€å–
      - TON_API_ENDPOINT=${TON_API_ENDPOINT:-https://testnet.toncenter.com/api/v2/}
      - TON_NETWORK=${TON_NETWORK:-testnet}

      # åˆç´„åœ°å€ - å¾ .env è®€å–
      - LOTTERY_CONTRACT_ADDRESS=${LOTTERY_CONTRACT_ADDRESS}
      - NFT_CONTRACT_ADDRESS=${NFT_CONTRACT_ADDRESS}

      # éŒ¢åŒ…é…ç½® - å¾ .env è®€å–
      - WALLET_PRIVATE_KEY=${WALLET_PRIVATE_KEY}

      # æŠ½çåƒæ•¸ - å¾ .env è®€å–
      - DRAW_INTERVAL=${DRAW_INTERVAL:-5m}
      - MAX_PARTICIPANTS=${MAX_PARTICIPANTS:-3}
      - MIN_PARTICIPANTS=${MIN_PARTICIPANTS:-1}
      - ENTRY_FEE_TON=${ENTRY_FEE_TON:-0.01}
      - AUTO_DRAW=${AUTO_DRAW:-false}

      # é‡è©¦é…ç½® - å¾ .env è®€å–
      - RETRY_COUNT=${RETRY_COUNT:-3}
      - RETRY_DELAY=${RETRY_DELAY:-5s}

    restart: unless-stopped
    # å¾Œç«¯æ˜¯å®ˆè­·é€²ç¨‹ï¼Œä¸æä¾› HTTP APIï¼Œæš«æ™‚è¨»é‡‹å¥åº·æª¢æŸ¥
    # healthcheck:
    #   test: ['CMD', 'curl', '-f', 'http://localhost:8080/health']
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 15s

  # ================================
  # å‰ç«¯æœå‹™
  # ================================
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
      target: production
    container_name: ton-cat-lottery-frontend
    ports:
      - '3000:80'
    networks:
      - ton-lottery-network
    environment:
      - NODE_ENV=production

    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:80/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ================================
  # å‰ç«¯é–‹ç™¼æœå‹™ (å¯é¸)
  # ================================
  frontend-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
      target: development
    container_name: ton-cat-lottery-frontend-dev
    ports:
      - '5173:5173'
    networks:
      - ton-lottery-network
    environment:
      - NODE_ENV=development
    volumes:
      - ./frontend:/app
      - /app/node_modules
    profiles:
      - development
    restart: unless-stopped

# ================================
# ç¶²è·¯é…ç½®
# ================================
networks:
  ton-lottery-network:
    driver: bridge
    name: ton-lottery-network
