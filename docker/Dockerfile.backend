# ğŸ³ TON Cat Lottery Backend Dockerfile
# åŸºæ–¼å®˜æ–¹ Go é¡åƒæ§‹å»ºå¾Œç«¯æœå‹™

# ================================
# æ§‹å»ºéšæ®µ
# ================================
FROM golang:1.22-alpine AS builder

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# å®‰è£æ§‹å»ºä¾è³´
RUN apk add --no-cache git ca-certificates

# è¤‡è£½å¾Œç«¯æºä»£ç¢¼
COPY backend/ ./

# ä¸‹è¼‰ä¾è³´
RUN go mod tidy

# æ§‹å»ºæ‡‰ç”¨ç¨‹å¼
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o ton-cat-lottery-backend main.go

# ================================
# é‹è¡Œéšæ®µ
# ================================
FROM alpine:latest

# å®‰è£é‹è¡Œæ™‚ä¾è³´
RUN apk --no-cache add ca-certificates tzdata curl

# è¨­ç½®æ™‚å€
ENV TZ=Asia/Taipei

# å‰µå»ºé root ç”¨æˆ¶
RUN adduser -D -s /bin/sh lottery

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# å¾æ§‹å»ºéšæ®µè¤‡è£½äºŒé€²åˆ¶æ–‡ä»¶
COPY --from=builder /app/ton-cat-lottery-backend .

# æ›´æ”¹æ–‡ä»¶æ“æœ‰è€…
RUN chown -R lottery:lottery /app

# åˆ‡æ›åˆ°é root ç”¨æˆ¶
USER lottery

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æª¢æŸ¥ - æš«æ™‚åœç”¨ï¼Œå› ç‚ºå¾Œç«¯æ˜¯å®ˆè­·é€²ç¨‹ä¸æä¾› HTTP API
# HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
#     CMD curl -f http://localhost:8080/health || exit 1

# å•Ÿå‹•å‘½ä»¤
CMD ["./ton-cat-lottery-backend"]