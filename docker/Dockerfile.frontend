# ğŸ³ TON Cat Lottery Frontend Dockerfile
# åŸºæ–¼ Node.js é¡åƒæ§‹å»º React + Vite å‰ç«¯æ‡‰ç”¨

# ================================
# åŸºç¤éšæ®µ
# ================================
FROM node:22-alpine AS base

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# å®‰è£ç³»çµ±ä¾è³´
RUN apk add --no-cache git curl

# ================================
# ä¾è³´å®‰è£éšæ®µ
# ================================
FROM base AS deps

# è¤‡è£½ package æ–‡ä»¶
COPY frontend/package*.json ./

# å®‰è£ä¾è³´
RUN npm ci --only=production && npm cache clean --force

# ================================
# é–‹ç™¼ä¾è³´éšæ®µ
# ================================
FROM base AS deps-dev

# è¤‡è£½ package æ–‡ä»¶
COPY frontend/package*.json ./

# å®‰è£æ‰€æœ‰ä¾è³´ (åŒ…æ‹¬é–‹ç™¼ä¾è³´)
RUN npm ci && npm cache clean --force

# ================================
# æ§‹å»ºéšæ®µ
# ================================
FROM deps-dev AS builder

# è¤‡è£½å‰ç«¯æºä»£ç¢¼
COPY frontend/ ./

# è¨­ç½®ç’°å¢ƒè®Šæ•¸
ENV NODE_ENV=production

# æ§‹å»ºå‰ç«¯æ‡‰ç”¨
RUN npm run build

# ================================
# ç”Ÿç”¢éšæ®µ (ä½¿ç”¨ nginx æä¾›éœæ…‹æ–‡ä»¶)
# ================================
FROM nginx:alpine AS production

# å‰µå»ºé root ç”¨æˆ¶
RUN adduser -D -s /bin/sh frontend

# å¾æ§‹å»ºéšæ®µè¤‡è£½éœæ…‹æ–‡ä»¶
COPY --from=builder /app/dist /usr/share/nginx/html

# è¤‡è£½ nginx é…ç½®
COPY docker/nginx/default.conf /etc/nginx/conf.d/default.conf

# è¨­ç½®æ­£ç¢ºçš„æ¬Šé™
RUN chown -R frontend:frontend /usr/share/nginx/html && \
    chown -R frontend:frontend /var/cache/nginx && \
    chown -R frontend:frontend /var/run && \
    chown -R frontend:frontend /var/log/nginx

# æš´éœ²ç«¯å£
EXPOSE 80

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:80/ || exit 1

# å•Ÿå‹• nginx
CMD ["nginx", "-g", "daemon off;"]

# ================================
# é–‹ç™¼éšæ®µ (ç”¨æ–¼é–‹ç™¼ç’°å¢ƒ)
# ================================
FROM deps-dev AS development

# è¤‡è£½å‰ç«¯æºä»£ç¢¼
COPY frontend/ ./

# å‰µå»ºé root ç”¨æˆ¶
RUN adduser -D -s /bin/sh frontend && \
    chown -R frontend:frontend /app

# åˆ‡æ›åˆ°é root ç”¨æˆ¶
USER frontend

# æš´éœ²é–‹ç™¼ç«¯å£
EXPOSE 5173

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:5173/ || exit 1

# å•Ÿå‹•é–‹ç™¼æœå‹™å™¨
CMD ["npm", "run", "dev"]