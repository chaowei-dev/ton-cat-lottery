# ğŸ³ TON Cat Lottery Contracts Dockerfile
# åŸºæ–¼ Node.js é¡åƒç”¨æ–¼æ™ºèƒ½åˆç´„ç·¨è­¯å’Œéƒ¨ç½²

# ================================
# åŸºç¤éšæ®µ
# ================================
FROM node:20-alpine AS base

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# å®‰è£ç³»çµ±ä¾è³´
RUN apk add --no-cache git python3 make g++ curl

# ================================
# ä¾è³´å®‰è£éšæ®µ
# ================================
FROM base AS deps

# è¤‡è£½ package æ–‡ä»¶
COPY contracts/package*.json ./

# å®‰è£ä¾è³´
RUN npm ci --only=production && npm cache clean --force

# ================================
# é–‹ç™¼ä¾è³´éšæ®µ
# ================================  
FROM base AS deps-dev

# è¤‡è£½ package æ–‡ä»¶
COPY contracts/package*.json ./

# å®‰è£æ‰€æœ‰ä¾è³´ (åŒ…æ‹¬é–‹ç™¼ä¾è³´)
RUN npm ci && npm cache clean --force

# ================================
# æ§‹å»ºéšæ®µ
# ================================
FROM deps-dev AS builder

# è¤‡è£½åˆç´„æºä»£ç¢¼
COPY contracts/ ./

# å…¨å±€å®‰è£ Tact ç·¨è­¯å™¨ (è·³é scripts é¿å… husky å•é¡Œ)
RUN npm install -g @tact-lang/compiler --ignore-scripts

# ç·¨è­¯æ™ºèƒ½åˆç´„
RUN npm run build

# é‹è¡Œæ¸¬è©¦
RUN npm test

# ================================
# é‹è¡Œéšæ®µ
# ================================
FROM base AS runner

# å‰µå»ºé root ç”¨æˆ¶
RUN adduser -D -s /bin/sh contracts

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# å¾ä¾è³´éšæ®µè¤‡è£½ node_modules
COPY --from=deps /app/node_modules ./node_modules

# å¾æ§‹å»ºéšæ®µè¤‡è£½æ§‹å»ºç”¢ç‰©
COPY --from=builder /app/build ./build
COPY --from=builder /app/scripts ./scripts
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/tact.config.json ./

# è¤‡è£½åˆç´„æºæ–‡ä»¶
COPY contracts/*.tact ./

# æ›´æ”¹æ–‡ä»¶æ“æœ‰è€…
RUN chown -R contracts:contracts /app

# åˆ‡æ›åˆ°é root ç”¨æˆ¶
USER contracts

# æš´éœ²ç«¯å£ (å¦‚æœéœ€è¦ HTTP æœå‹™)
EXPOSE 3000

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD test -f ./build/CatLottery_CatLottery.ts || exit 1

# é»˜èªå‘½ä»¤ï¼šé¡¯ç¤ºæ§‹å»ºä¿¡æ¯
CMD ["sh", "-c", "echo 'ğŸ¯ æ™ºèƒ½åˆç´„å·²ç·¨è­¯å®Œæˆ' && ls -la build/ && tail -f /dev/null"]